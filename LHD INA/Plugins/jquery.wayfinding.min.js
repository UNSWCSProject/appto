/*

 Wayfinding v0.1
 http://code.google.com/p/wayfinding/

 requires Keith Wood's SVG plugin.
 jquery.svg.js
 jquery.svgdom.js
 jquery.svganim.js -- modify to allow animation of strokeDashOffset

 Copyright (c) 2010 University of California Regents
 Licensed under GNU General Public License v2
 http://www.gnu.org/licenses/old-licenses/gpl-2.0.html

 Date: 2010-08-28

*/
(function(i){var G={maps:[{path:"floorplan.svg",id:"map.1"}],path:{color:"red",radius:10,speed:8,width:3},startpoint:function(){return"startpoint"},accessibleRoute:false,defaultMap:function(){return"map.1"}};i.fn.wayfinding=function(y,l){function H(){var e,b,d=false,c=false;if(m.length>0){for(e=0;e<m.length;e++)for(b=e;b<m.length;b++)if(e!==b&&m[e].id===m[b].id)d=true;if(d===true)for(e=0;e<m.length;e++)m[e].id="map_"+e;for(e=0;e<m.length;e++)if(m[e].id===B)c=true;if(c===false)B=m[0].id}}function I(e){a.paths=
[];a.portals=[];e.attr("style","margin-left:1920px");i.each(m,function(b,d){var c=e.append('<div id="'+d.id+'"></div>').find("div:last");c.svg();m[b].svgHandle=c.svg("get");m[b].svgHandle.load(d.path,setTimeout(function(){J(e,b,d);b===m.length-1&&K(e)},2500))})}function J(e,b,d){var c,o,g,k,n,f,q,r;i("#"+d.id+" #Paths line",e).attr("stroke-opacity",0);i("#"+d.id+" #Doors line",e).attr("stroke-opacity",0);i("#"+d.id+" #Portals line",e).attr("stroke-opacity",0);i("#"+d.id+" #Rooms a",e).each(function(){if(i(this).attr("id")&&
i(this).attr("id").indexOf("_")>0){var s=i(this).attr("id");i(this).attr("id",s.slice(0,s.indexOf("_")))}});a.paths[b]=[];i("#"+d.id+" #Paths line",e).each(function(){c={};c.floor=d.id;c.mapNum=b;c.route=Infinity;c.prior=-1;c.ax=i(this).attr("x1");c.ay=i(this).attr("y1");c.doorA=[];c.bx=i(this).attr("x2");c.by=i(this).attr("y2");c.doorB=[];c.length=Math.sqrt(Math.pow(c.ax-c.bx,2)+Math.pow(c.ay-c.by,2));c.connections=[];c.portals=[];a.paths[b].push(c)});i("#"+d.id+" #Doors line",e).each(function(){if((o=
i(this).attr("id"))&&o.indexOf("_")>-1)o=o.slice(0,o.indexOf("_"));g=i(this).attr("x1");k=i(this).attr("y1");n=i(this).attr("x2");f=i(this).attr("y2");i.each(a.paths[b],function(s,p){if(d.id===p.floor&&(p.ax===g&&p.ay===k||p.ax===n&&p.ay===f))p.doorA.push(o);else if(d.id===p.floor&&(p.bx===g&&p.by===k||p.bx===n&&p.by===f))p.doorB.push(o)})});i("#"+d.id+" #Portals line",e).each(function(){r={};r.id=i(this).attr("id");r.type=i(this).attr("id").split(".")[0];r.floor=d.id;r.mate=i(this).attr("id").split(".").slice(0,
2).join(".")+"."+d.id;r.mapNum=b;r.matched=false;g=i(this).attr("x1");k=i(this).attr("y1");n=i(this).attr("x2");f=i(this).attr("y2");q=i.grep(a.paths[b],function(s){return d.id===s.floor&&g===s.ax&&k===s.ay||d.id===s.floor&&g===s.bx&&k===s.by});if(q!==0){r.x=g;r.y=k}else{r.x=n;r.y=f}r.length=Math.sqrt(Math.pow(g-n,2)+Math.pow(k-f,2));w.push(r)})}function K(e){var b,d,c,o,g;for(b=0;b<w.length;b++){c=w[b];if(c.matched===false)for(d=b;d<w.length;d++)if(w[d].id===c.mate&&w[d].mate===c.id){o=w[d];g={};
c.matched=true;o.matched=true;g.type=c.type;g.accessible=g.type==="Elev"?true:false;g.idA=c.id;g.floorA=c.floor;g.floorANum=c.mapNum;g.xA=c.x;g.yA=c.y;g.connectionsA=[];g.idB=o.id;g.floorB=o.floor;g.floorBNum=o.mapNum;g.xB=o.x;g.yB=o.y;g.connectionsB=[];g.length=c.length+o.length;g.route=Infinity;g.prior=-1;a.portals.push(g)}}for(b=0;b<m.length;b++)for(d=0;d<a.paths[b].length-1;d++)for(c=d+1;c<a.paths[b].length;c++)if(a.paths[b][c].ax===a.paths[b][d].ax&&a.paths[b][c].ay===a.paths[b][d].ay||a.paths[b][c].bx===
a.paths[b][d].ax&&a.paths[b][c].by===a.paths[b][d].ay||a.paths[b][c].ax===a.paths[b][d].bx&&a.paths[b][c].ay===a.paths[b][d].by||a.paths[b][c].bx===a.paths[b][d].bx&&a.paths[b][c].by===a.paths[b][d].by){a.paths[b][d].connections.push(c);a.paths[b][c].connections.push(d)}for(d=0;d<a.portals.length;d++)for(b=0;b<m.length;b++)for(c=0;c<a.paths[b].length;c++)if(a.portals[d].floorA===a.paths[b][c].floor&&(a.portals[d].xA===a.paths[b][c].ax&&a.portals[d].yA===a.paths[b][c].ay||a.portals[d].xA===a.paths[b][c].bx&&
a.portals[d].yA===a.paths[b][c].by)){a.portals[d].connectionsA.push(c);a.paths[b][c].portals.push(d)}else if(a.portals[d].floorB===a.paths[b][c].floor&&(a.portals[d].xB===a.paths[b][c].ax&&a.portals[d].yB===a.paths[b][c].ay||a.portals[d].xB===a.paths[b][c].bx&&a.portals[d].yB===a.paths[b][c].by)){a.portals[d].connectionsB.push(c);a.paths[b][c].portals.push(d)}w=[];i("#Rooms a",e).click(function(k){i(e).wayfinding("routeTo",i(this).attr("id"));k.preventDefault()});i(e).attr("style","margin-left:0px");
i("#mapLoading").remove();for(b=d=0;b<m.length;b++)if(B===m[b].id)d=b;i("div",e).hide();i("#"+m[d].id,e).show()}function F(e,b){i("div",b).hide();i("#"+e,b).show();var d,c,o;if(h){o=-1;for(d=0;d<m.length;d++)if(m[d]===e)o=d;c=-1;for(d=0;d<h.length;d++)if(h[d].floor===o)c=d;if(c!==-1){d=h[c].routeLength;i(h[c].path,b).attr("stroke-dasharray",[d,d]);i(h[c].path,b).attr("stroke-dashoffset",d);i(h[c].path,b).attr("pathLength",d);i(h[c].path,b).attr("stroke-dashoffset",d);i(h[c].path,b).animate({svgStrokeDashOffset:0},
d*l.path.speed)}}}function L(e){var b,d,c,o,g,k,n,f,q,r,s;i("path[class='directionPath']",t).remove();i("#Rooms *[class=wayfindingRoom]",t).removeClass("wayfindingRoom");for(b=0;b<m.length;b++)for(d=0;d<a.paths[b].length;d++){a.paths[b][d].route=Infinity;a.paths[b][d].prior=-1}for(c=0;c<a.portals.length;c++){a.portals[c].route=Infinity;a.portals[c].prior=-1;a.portals[c].priormapNum=-1}j=[];if(z!==e){o=[];c=[];i("#Rooms a[id='"+e+"'] g",t).addClass("wayfindingRoom");for(b=0;b<m.length;b++)for(d=0;d<
a.paths[b].length;d++){for(q=0;q<a.paths[b][d].doorA.length;q++)if(a.paths[b][d].doorA[q]===z){o.push(d);g=a.paths[b][d].floor}for(q=0;q<a.paths[b][d].doorB.length;q++)if(a.paths[b][d].doorB[q]===z){o.push(d);g=a.paths[b][d].floor}}for(b=0;b<m.length;b++)for(d=0;d<a.paths[b].length;d++){for(q=0;q<a.paths[b][d].doorA.length;q++)if(a.paths[b][d].doorA[q]===e){c.push(d);k=a.paths[b][d].floor}for(q=0;q<a.paths[b][d].doorB.length;q++)if(a.paths[b][d].doorB[q]===e){c.push(d);k=a.paths[b][d].floor}}for(b=
0;b<m.length;b++){if(m[b].id===g)n=b;if(m[b].id===k)f=b}i.each(o,function(p,x){a.paths[n][x].route=a.paths[n][x].length;a.paths[n][x].prior="door";C("pa",n,x,a.paths[n][x].length)});g=Infinity;k=-1;for(e=0;e<c.length;e++)if(a.paths[f][c[e]].route<g){g=a.paths[f][c[e]].route;k=c[e]}if(k!==-1){E("pa",f,k);j.reverse();for(e=g=0;e<j.length;e++)j[e].type==="po"&&g++;h=Array(g);h[0]=[];f={};if(a.paths[j[0].floor][j[0].segment].doorA[0]===z){f={};f.floor=[j[0].floor];f.type="M";f.x=a.paths[j[0].floor][j[0].segment].ax;
f.y=a.paths[j[0].floor][j[0].segment].ay;f.length=0;h[0].push(f);f={};f.type="L";f.floor=[j[0].floor];f.x=a.paths[j[0].floor][j[0].segment].bx;f.y=a.paths[j[0].floor][j[0].segment].by;f.length=a.paths[j[0].floor][j[0].segment].length;h[0].push(f);h[0].routeLength=f.length}else if(a.paths[j[0].floor][j[0].segment].doorB[0]===z){f={};f.type="M";f.floor=[j[0].floor];f.x=a.paths[j[0].floor][j[0].segment].bx;f.y=a.paths[j[0].floor][j[0].segment].by;f.length=0;h[0].push(f);f={};f.type="L";f.floor=[j[0].floor];
f.x=a.paths[j[0].floor][j[0].segment].ax;f.y=a.paths[j[0].floor][j[0].segment].ay;f.length=a.paths[j[0].floor][j[0].segment].length;h[0].push(f);h[0].routeLength=f.length}k=1;for(e=0;e<g+1;e++)for(c=k;c<j.length;c++){if(j[c].type==="pa"){b=a.paths[j[c].floor][j[c].segment].ax;d=a.paths[j[c].floor][j[c].segment].ay;o=a.paths[j[c].floor][j[c].segment].bx;q=a.paths[j[c].floor][j[c].segment].by;f={};f.floor=j[c].floor;if(h[e].slice(-1)[0].x===b&&h[e].slice(-1)[0].y===d){f.x=o;f.y=q}else{f.x=b;f.y=d}f.length=
a.paths[j[c].floor][j[c].segment].length;f.type="L";h[e].push(f);h[e].routeLength+=f.length}if(j[c].type==="po"){h[e+1]=[];h[e+1].routeLength=0;if(a.portals[j[c].segment].floorANum===j[c].floor){f={};f.floor=j[c].floor;f.type="M";f.x=a.portals[j[c].segment].xA;f.y=a.portals[j[c].segment].yA;f.length=0;h[e+1].push(f);h[e+1].routeLength=f.length}else if(a.portals[j[c].segment].floorBNum===j[c].floor){f={};f.floor=j[c].floor;f.type="M";f.x=a.portals[j[c].segment].xB;f.y=a.portals[j[c].segment].yB;f.length=
0;h[e+1].push(f);h[e+1].routeLength=f.length}k=c;k++;c=j.length}}if(l.path.radius>0)for(f=0;f<h.length;f++){for(e=1;e<h[f].length-1;e++)if(h[f][e].type==="L"&&h[f][e].type==="L"){c=h[f][e-1].x-h[f][e].x;g=h[f][e-1].y-h[f][e].y;k=h[f][e].x-h[f][e+1].x;b=h[f][e].y-h[f][e+1].y;if(g===0&&b===0||c===0&&k===0||c/g===k/b&&!(c===0&&g===0&&k===0&&b===0)){h[f][e+1].length=h[f][e].length+h[f][e+1].length;h[f].splice(e,1);e=1}}for(e=1;e<h[f].length-1;e++)if(h[f][e].type==="L"&&h[f][e].type==="L"&&h[f][e].length>
l.path.radius&&h[f][e+1].length>l.path.radius){c=h[f][e].x;g=h[f][e].y;k=h[f][e-1].x;b=h[f][e-1].y;h[f][e].x=Number(k)+(c-k)*((h[f][e].length-l.path.radius)/h[f][e].length);h[f][e].y=Number(b)+(g-b)*((h[f][e].length-l.path.radius)/h[f][e].length);h[f][e].length-=l.path.radius;k={};k.cx=c;k.cy=g;b=h[f][e+1].x;d=h[f][e+1].y;k.x=Number(c)+(b-c)*(l.path.radius/h[f][e+1].length);k.y=Number(g)+(d-g)*(l.path.radius/h[f][e+1].length);h[f][e+1].length-=l.path.radius;k.type="Q";k.floor=h[f][e].floor;h[f].splice(e+
1,0,k)}}F(m[h[0][0].floor].id,t);i.each(h,function(p,x){var D="";i.each(x,function(M,u){switch(u.type){case "M":D="M"+u.x+","+u.y;break;case "L":D+="L"+u.x+","+u.y;break;case "Q":D+="Q"+u.cx+","+u.cy+" "+u.x+","+u.y;break}});if(p>0)directionSwap=setTimeout(function(){i("#"+m[h[p-1][0].floor].id,t).hide();i("#"+m[h[p][0].floor].id,t).show()},Math.round(h[p].routeLength*l.path.speed));s=m[x[0].floor].svgHandle.path(D,{stroke:l.path.color,strokeWidth:l.path.width,fill:"none","class":"directionPath"});
h[p].path=s;r=h[p].routeLength;i(h[p].path).attr("stroke-dasharray",[r,r]);i(h[p].path).attr("stroke-dashoffset",r);i(h[p].path).attr("pathLength",r);i(h[p].path).animate({svgStrokeDashOffset:0},r*l.path.speed)})}}}function C(e,b,d,c){i.each(a.paths[b][d].connections,function(o,g){if(c+a.paths[b][g].length<a.paths[b][g].route){a.paths[b][g].route=c+a.paths[b][g].length;a.paths[b][g].prior=d;a.paths[b][g].priorType=e;C("pa",b,g,a.paths[b][g].route)}});a.paths[b][d].portals.length>0&&i.each(a.paths[b][d].portals,
function(o,g){if(c+a.portals[g].length<a.portals[g].route&&(l.accessibleRoute===false||l.accessibleRoute===true&&a.portals[g].accessible)){a.portals[g].route=c+a.portals[g].length;a.portals[g].prior=d;a.portals[g].priormapNum=a.paths[b][d].mapNum;a.portals[g].priorType=e;i.inArray(d,a.portals[g].connectionsA)!==-1?i.each(a.portals[g].connectionsB,function(k,n){if(c+a.portals[g].length+a.paths[a.portals[g].floorBNum][n].length<a.paths[a.portals[g].floorBNum][n].route){a.paths[a.portals[g].floorBNum][n].route=
a.portals[g].route+a.paths[a.portals[g].floorBNum][n].length;a.paths[a.portals[g].floorBNum][n].prior=g;a.paths[a.portals[g].floorBNum][n].priorType="po";C("pa",a.portals[g].floorBNum,n,a.paths[a.portals[g].floorBNum][n].route)}}):i.each(a.portals[g].connectionsA,function(k,n){if(c+a.portals[g].length+a.paths[a.portals[g].floorANum][n].length<a.paths[a.portals[g].floorANum][n].route){a.paths[a.portals[g].floorANum][n].route=a.portals[g].route+a.paths[a.portals[g].floorANum][n].length;a.paths[a.portals[g].floorANum][n].prior=
g;a.paths[a.portals[g].floorANum][n].priorType="po";C("pa",a.portals[g].floorANum,n,a.paths[a.portals[g].floorANum][n].route)}})}})}function E(e,b,d){var c;if(d!=="door"){c={};c.type=e;c.floor=b;c.segment=d;j.push(c);switch(e){case "pa":E(a.paths[b][d].priorType,b,a.paths[b][d].prior);break;case "po":E(a.portals[d].priorType,a.portals[d].priormapNum,a.portals[d].prior);break}}}var v=l,a={paths:[],portals:[]},t,m,B,z,w=[],h,j,A;if(y&&typeof y==="object"){l=y;y="initialize"}this.each(function(){t=i(this);
(function(e){var b=e.data("wayfinding:options"),d=e.data("wayfinding:data");l=b!==null?b:i.extend(true,{},G,l);l=i.metadata?i.extend(true,{},l,e.metadata()):l;m=l.maps;B=typeof l.defaultMap==="function"?l.defaultMap():l.defaultMap;z=typeof l.startpoint==="function"?l.startpoint():l.startpoint;if(d!==null)a=d})(t);if(y&&typeof y==="string")switch(y){case "initialize":H();I(t);break;case "routeTo":L(v);break;case "startpoint":if(v===undefined)A=z;else l.startpoint=v;break;case "currentMap":if(v===undefined)A=
i("div:visible",t).attr("id");else F(v,t);break;case "accessibleRoute":if(v===undefined)A=l.accessibleRoute;else l.accessibleRoute=v;break;case "path":if(v===undefined)A=l.path;else l.path=i.extend(true,{},l.path,v);break;case "destroy":i(t).remove();break;default:break}(function(e){e.data("wayfinding:options",l);e.data("wayfinding:data",a)})(t)});if(A!==undefined)return A;return this}})(jQuery);